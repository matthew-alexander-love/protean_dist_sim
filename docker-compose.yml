version: '3.8'

# Simplified Distributed Protean Simulation - Docker Compose Configuration
# Uses pre-built images and docker compose scaling for workers

services:
  # =========================================================================
  # Coordinator Service
  # =========================================================================
  coordinator:
    image: protean-dist-sim-coordinator:latest
    container_name: protean-coordinator
    hostname: coordinator

    # Mount configuration and data
    volumes:
      # Configuration files
      - ./deploy/coordinator_config.yaml:/app/config/coordinator_config.yaml:ro
      - ./deploy/test_plan.yaml:/app/config/test_plan.yaml:ro

      # Dataset files (user must provide these)
      - ./data:/app/data:ro

      # Output directory for results
      - ./output:/app/output

    # Coordinator listens on port 50050
    ports:
      - "50050:50050"

    # Environment variables
    environment:
      - RUST_LOG=trace
      - RUST_BACKTRACE=1

    # Health check
    healthcheck:
      test: ["CMD", "timeout", "5", "bash", "-c", "</dev/tcp/localhost/50050"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Resource limits for deployment
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

    # Restart policy
    restart: unless-stopped

    # Networks
    networks:
      - protean-network

  # =========================================================================
  # Worker Services (matches coordinator_config.yaml)
  # =========================================================================
  worker0:
    image: protean-dist-sim-worker:latest
    container_name: worker0
    hostname: worker0
    command: ["--worker-id=worker0", "--bind-address=0.0.0.0:50051", "--advertise-address=worker0:50051", "--coordinator-address=coordinator:50050", "--n-workers=11", "--max-actors=1000"]
    environment:
      - RUST_LOG=trace
      - RUST_BACKTRACE=1
    networks:
      - protean-network
    depends_on:
      coordinator:
        condition: service_started
    restart: unless-stopped

  worker1:
    image: protean-dist-sim-worker:latest
    container_name: worker1
    hostname: worker1
    command: ["--worker-id=worker1", "--bind-address=0.0.0.0:50051", "--advertise-address=worker1:50051", "--coordinator-address=coordinator:50050", "--n-workers=11", "--max-actors=1000"]
    environment:
      - RUST_LOG=trace
      - RUST_BACKTRACE=1
    networks:
      - protean-network
    depends_on:
      coordinator:
        condition: service_started
    restart: unless-stopped

  worker2:
    image: protean-dist-sim-worker:latest
    container_name: worker2
    hostname: worker2
    command: ["--worker-id=worker2", "--bind-address=0.0.0.0:50051", "--advertise-address=worker2:50051", "--coordinator-address=coordinator:50050", "--n-workers=11", "--max-actors=1000"]
    environment:
      - RUST_LOG=trace
      - RUST_BACKTRACE=1
    networks:
      - protean-network
    depends_on:
      coordinator:
        condition: service_started
    restart: unless-stopped

  worker3:
    image: protean-dist-sim-worker:latest
    container_name: worker3
    hostname: worker3
    command: ["--worker-id=worker3", "--bind-address=0.0.0.0:50051", "--advertise-address=worker3:50051", "--coordinator-address=coordinator:50050", "--n-workers=11", "--max-actors=1000"]
    environment:
      - RUST_LOG=trace
      - RUST_BACKTRACE=1
    networks:
      - protean-network
    depends_on:
      coordinator:
        condition: service_started
    restart: unless-stopped

  worker4:
    image: protean-dist-sim-worker:latest
    container_name: worker4
    hostname: worker4
    command: ["--worker-id=worker4", "--bind-address=0.0.0.0:50051", "--advertise-address=worker4:50051", "--coordinator-address=coordinator:50050", "--n-workers=11", "--max-actors=1000"]
    environment:
      - RUST_LOG=trace
      - RUST_BACKTRACE=1
    networks:
      - protean-network
    depends_on:
      coordinator:
        condition: service_started
    restart: unless-stopped

  worker5:
    image: protean-dist-sim-worker:latest
    container_name: worker5
    hostname: worker5
    command: ["--worker-id=worker5", "--bind-address=0.0.0.0:50051", "--advertise-address=worker5:50051", "--coordinator-address=coordinator:50050", "--n-workers=11", "--max-actors=1000"]
    environment:
      - RUST_LOG=trace
      - RUST_BACKTRACE=1
    networks:
      - protean-network
    depends_on:
      coordinator:
        condition: service_started
    restart: unless-stopped

  worker6:
    image: protean-dist-sim-worker:latest
    container_name: worker6
    hostname: worker6
    command: ["--worker-id=worker6", "--bind-address=0.0.0.0:50051", "--advertise-address=worker6:50051", "--coordinator-address=coordinator:50050", "--n-workers=11", "--max-actors=1000"]
    environment:
      - RUST_LOG=trace
      - RUST_BACKTRACE=1
    networks:
      - protean-network
    depends_on:
      coordinator:
        condition: service_started
    restart: unless-stopped

  worker7:
    image: protean-dist-sim-worker:latest
    container_name: worker7
    hostname: worker7
    command: ["--worker-id=worker7", "--bind-address=0.0.0.0:50051", "--advertise-address=worker7:50051", "--coordinator-address=coordinator:50050", "--n-workers=11", "--max-actors=1000"]
    environment:
      - RUST_LOG=trace
      - RUST_BACKTRACE=1
    networks:
      - protean-network
    depends_on:
      coordinator:
        condition: service_started
    restart: unless-stopped

  worker8:
    image: protean-dist-sim-worker:latest
    container_name: worker8
    hostname: worker8
    command: ["--worker-id=worker8", "--bind-address=0.0.0.0:50051", "--advertise-address=worker8:50051", "--coordinator-address=coordinator:50050", "--n-workers=11", "--max-actors=1000"]
    environment:
      - RUST_LOG=trace
      - RUST_BACKTRACE=1
    networks:
      - protean-network
    depends_on:
      coordinator:
        condition: service_started
    restart: unless-stopped

  worker9:
    image: protean-dist-sim-worker:latest
    container_name: worker9
    hostname: worker9
    command: ["--worker-id=worker9", "--bind-address=0.0.0.0:50051", "--advertise-address=worker9:50051", "--coordinator-address=coordinator:50050", "--n-workers=11", "--max-actors=1000"]
    environment:
      - RUST_LOG=trace
      - RUST_BACKTRACE=1
    networks:
      - protean-network
    depends_on:
      coordinator:
        condition: service_started
    restart: unless-stopped

  worker10:
    image: protean-dist-sim-worker:latest
    container_name: worker10
    hostname: worker10
    command: ["--worker-id=worker10", "--bind-address=0.0.0.0:50051", "--advertise-address=worker10:50051", "--coordinator-address=coordinator:50050", "--n-workers=11", "--max-actors=1000"]
    environment:
      - RUST_LOG=trace
      - RUST_BACKTRACE=1
    networks:
      - protean-network
    depends_on:
      coordinator:
        condition: service_started
    restart: unless-stopped

# =========================================================================
# Networks
# =========================================================================
networks:
  protean-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# =========================================================================
# Volumes (for persistent data if needed)
# =========================================================================
volumes:
  protean-output:
    driver: local
