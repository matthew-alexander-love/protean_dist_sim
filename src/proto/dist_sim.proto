syntax = "proto3";

package protean_proto.sim;

option optimize_for = LITE_RUNTIME;

import "onnx-ml.proto";
import "protean.proto";

/* --------------------- Services --------------------- */

service WorkerNode {
    // Lifecycle & Configuration
    /// Set worker-wide simulation configuration
    rpc SetConfig(protean_proto.SnvConfigProto) returns (Ack) {}

    /// Load embeddings into worker's embedding pool
    rpc LoadEmbeddings(LoadEmbeddingsRequest) returns (Ack) {}

    /// Create multiple peers at once (for bootstrapping)
    rpc CreatePeers(CreatePeersRequest) returns (Ack) {}

    /// Delete specific peers by UUID
    rpc DeletePeers(DeletePeersRequest) returns (Ack) {}

    /// Start a Churn Pattern
    rpc DriftPeer(DriftPeerRequest) returns (Ack) {}

    // Query Execution
    /// Execute a query from a specific peer
    rpc ExecuteQuery(QueryRequest) returns (QueryResponse) {}

    // State Management
    /// Get snapshot of current network state (all or filtered peers)
    rpc GetSnapshot(SnapshotRequest) returns (NetworkSnapshot) {}

    /// Load network state from snapshot
    rpc LoadSnapshot(NetworkSnapshot) returns (Ack) {}

    /// Health check
    rpc Ping(PingRequest) returns (Ack) {} //

    /// Inform about another worker that can be sent messages
    rpc RegisterWorker(WorkerInfo) returns (Ack) {}

    /// Route a protocol message to a peer on this worker
    rpc RouteMessage(RouteMessageRequest) returns (Ack) {}
}

service CoordinatorNode {
    // Worker Registration & Health
    /// Worker registers with coordinator
    rpc RegisterWorker(WorkerInfo) returns (Ack) {}

    rpc ForwardEvent(ProteanEventProto) returns (Ack) {}
}


/* --------------------- Common Messages --------------------- */

message Ack {
    bool success = 1;
    string message = 2;
}

message PingRequest {
    // Empty - just a health check
}

/* --------------------- Embedding Management Messages --------------------- */

message IndexedEmbeddingProto {
    onnx.TensorProto embeddings = 1;
    uint64 global_idx = 2;
}

/// Request to load embeddings into worker's embedding pool
message LoadEmbeddingsRequest {
    repeated IndexedEmbeddingProto embeddings = 1;
}

/* --------------------- Peer Lifecycle Messages --------------------- */

/// Bootstrap peer information for peer creation
message BootstrapPeerInfo {
    bytes uuid = 1;                      // UUID of bootstrap peer
    onnx.TensorProto embedding = 2;      // Embedding of bootstrap peer
    string worker_address = 3;           // Address of worker hosting bootstrap peer
}

/// Request to create multiple peers
message CreatePeersRequest {
    repeated uint64 global_indices = 1;  // Global dataset indices for peers to create
    uint64 bootstrap_index = 2;          // DEPRECATED: Global index of bootstrap peer (use bootstrap_peer instead)
    BootstrapPeerInfo bootstrap_peer = 3; // Bootstrap peer information (optional)
}

/// Request to delete specific peers
message DeletePeersRequest {
    repeated uint64 global_indices = 1;  // Global indices of peers to delete
}

message DriftPeerProto {
    bytes peer_uuid = 1;        // UUID of the peer to drift
    uint64 target_idx = 2;      // Global index of target embedding to drift towards
    uint64 num_steps = 3;       // Number of drift steps
    uint64 update_interval_ms = 4;  // Interval between drift updates in milliseconds
}

message DriftPeerRequest {
    repeated DriftPeerProto drifts = 1;
}

/* --------------------- Query Messages --------------------- */

/// Request to execute a query from a specific peer
message QueryRequest {
    bytes source_peer_uuid = 1;             // UUID of peer executing the query
    onnx.TensorProto query_embedding = 2;   // Query point in embedding space
    uint32 k = 3;                            // Number of neighbors to find
    protean_proto.QueryConfigProto config = 4;  // Query execution config
}

/// Response containing query UUID (results come via event forwarding)
message QueryResponse {
    bytes query_uuid = 1;  // Unique query identifier
}

/* --------------------- Snapshot Messages --------------------- */

/// Request for network snapshot
message SnapshotRequest {
    repeated bytes peer_uuids = 1;  // Specific peers to snapshot (empty = all)
}

/// Complete network snapshot
message NetworkSnapshot {
    uint64 timestamp_ms = 1;  // Snapshot timestamp
    string worker_id = 2;      // Worker that generated this snapshot
    repeated protean_proto.SparseNeighborViewProto peer_snapshots = 3;
}

/* --------------------- Worker Registration Messages --------------------- */

/// Worker information for registration
/// Peers dont need to know there centroid
message WorkerInfo {
    string address = 1;           // gRPC address of worker (host:port)
}

/// Heartbeat from worker to coordinator
message HeartbeatRequest {
    string worker_id = 1;
    uint32 active_peers = 2;      // Current number of active peers
    float cpu_usage = 3;           // CPU usage percentage (0-100)
    float memory_usage = 4;        // Memory usage percentage (0-100)
}

/* --------------------- Message Routing Messages --------------------- */

/// Request to route a protocol message to a peer
message RouteMessageRequest {
    bytes destination_uuid = 1;                      // UUID of destination peer
    protean_proto.ProteanMessageProto message = 2;   // Protocol message to route
}

/* --------------------- Event Streaming Messages --------------------- */

/// Protean event types that can be streamed
enum ProteanEventType {
    STATE_CHANGED = 0;
    QUERY_COMPLETED = 1;
    BOOTSTRAP_CONVERGING_COMPLETED = 2;
    BOOTSTRAP_COMPLETED = 3;
}

/// Event: Peer state transition
message StateChangedEvent {
    bytes peer_uuid = 1;
    string from_state = 2;
    string to_state = 3;
}

/// Event: Query completed with results
message QueryCompletedEvent {
    bytes peer_uuid = 1;
    bytes query_uuid = 2;
    repeated protean_proto.QueryCandidateProto candidates = 3;
    uint32 hops = 4;
    uint64 latency_ms = 5;
}

/// Event: Bootstrap converging phase completed
message BootstrapConvergingCompletedEvent {
    bytes peer_uuid = 1;
}

/// Event: Bootstrap fully completed
message BootstrapCompletedEvent {
    bytes peer_uuid = 1;
}

/// Unified event message
message ProteanEventProto {
    ProteanEventType event_type = 1;
    uint64 timestamp_ms = 3;  // Event timestamp (ms since epoch)

    oneof event {
        StateChangedEvent state_changed = 4;
        QueryCompletedEvent query_completed = 5;
        BootstrapConvergingCompletedEvent bootstrap_converging_completed = 6;
        BootstrapCompletedEvent bootstrap_completed = 7;
    }
}